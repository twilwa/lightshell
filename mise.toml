# ABOUTME: mise en place configuration for Discord Stage AI Bot
# ABOUTME: Defines development tools, tasks, and environment settings

[tools]
node = "22"

[env]
NODE_ENV = "development"

[tasks.dev]
description = "Run in development mode with auto-reload"
run = "npm run dev"

[tasks.build]
description = "Build TypeScript to JavaScript"
run = "npm run build"

[tasks.test]
description = "Run test suite"
run = "npm test"

[tasks.test-watch]
description = "Run tests in watch mode"
run = "npm run test:watch"

[tasks.test-condensed]
description = "Run tests with condensed output (failures only)"
run = """
npm test 2>&1 | awk '
  /FAIL|Failed|Error:|AssertionError/ { print; fail=1 }
  /Test Files.*passed/ { summary=$0 }
  /Tests.*passed/ { summary=summary "\\n" $0 }
  END { 
    if (!fail) print "âœ… All tests passing"
    print summary
  }
'
"""

[tasks.test-quick]
description = "Ultra-compressed test output for CI/workers"
run = """
npm test 2>&1 | tail -5 | grep -E "(Test Files|Tests|Duration)" || echo "âš ï¸ Test output parsing failed"
"""

[tasks.test-coverage]
description = "Run tests with coverage"
run = "npm run test:coverage"

[tasks.lint]
description = "Run linters with autofix"
run = "trunk check --fix"

[tasks.fmt]
description = "Format code"
run = "trunk fmt"

[tasks.check]
description = "Run all checks (lint + test)"
depends = ["lint", "test"]

[tasks.deploy-commands]
description = "Deploy Discord slash commands"
run = "npx ts-node src/commands/deploy.ts"

[tasks.start]
description = "Start bot in dev mode with auto-reload (requires .env)"
run = "npm run dev"

[tasks.bot]
description = "Full dev startup: deploy commands then start bot"
depends = ["deploy-commands"]
run = "npm run dev"

[tasks.test-memory]
description = "Test per-user memory integration with compressed status output"
run = """
#!/bin/bash
set -o pipefail

echo "â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®"
echo "â”‚  Per-User Memory Integration Test Suite                    â”‚"
echo "â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯"
echo ""

# Run tests with JSON output for parsing
OUTPUT=$(npm test -- --reporter=json \
  tests/unit/memory/manager.test.ts \
  tests/unit/memory/blocks.test.ts \
  tests/unit/memory/labels.test.ts \
  tests/unit/voice/orchestration/voice-orchestrator.test.ts \
  2>/dev/null)

# Parse results
TOTAL=$(echo "$OUTPUT" | grep -o '"numTotalTests":[0-9]*' | cut -d: -f2)
PASSED=$(echo "$OUTPUT" | grep -o '"numPassedTests":[0-9]*' | cut -d: -f2)
FAILED=$(echo "$OUTPUT" | grep -o '"numFailedTests":[0-9]*' | cut -d: -f2)
SUCCESS=$(echo "$OUTPUT" | grep -o '"success":true' | wc -l)

echo "ğŸ“Š Summary: $PASSED/$TOTAL tests passed"
echo ""

if [ "$FAILED" -gt 0 ]; then
  echo "âŒ FAILURES DETECTED"
  echo "$OUTPUT" | grep -o '"title":"[^"]*".*"status":"failed"' | head -10
  exit 1
fi

echo "âœ… All memory integration code paths working:"
echo ""
echo "  MemoryManager (src/memory/manager.ts)"
echo "    â”œâ”€ attachUserBlocks()    [get-or-create + attach + timeout]"
echo "    â”œâ”€ detachUserBlocks()    [batch detach + error tolerance]"
echo "    â”œâ”€ destroy()             [cleanup tracked blocks]"
echo "    â”œâ”€ withTimeout()         [API call timeout protection]"
echo "    â”œâ”€ isServerAvailable()   [health state check]"
echo "    â””â”€ resetServerState()    [recovery from unavailable]"
echo ""
echo "  Events Emitted:"
echo "    â”œâ”€ memoryOperationComplete  [attach/detach latency metrics]"
echo "    â”œâ”€ memoryAttachFailed       [graceful degradation]"
echo "    â”œâ”€ memoryDetachFailed       [cleanup error logging]"
echo "    â””â”€ serverUnavailable        [connection monitoring]"
echo ""
echo "  Block Management (src/memory/blocks.ts)"
echo "    â”œâ”€ getOrCreateUserBlock()   [idempotent block creation]"
echo "    â”œâ”€ attachBlockToAgent()     [409 conflict tolerance]"
echo "    â””â”€ detachBlockFromAgent()   [404 not-found tolerance]"
echo ""
echo "  VoiceOrchestrator Integration"
echo "    â”œâ”€ memoryManager config     [optional dependency injection]"
echo "    â”œâ”€ attach before LLM call   [user context loaded]"
echo "    â”œâ”€ detach in finally block  [guaranteed cleanup]"
echo "    â””â”€ graceful without memory  [degraded mode works]"
echo ""
echo "  Label Format: /{agentId}/discord/users/{userId}"
echo ""
"""
